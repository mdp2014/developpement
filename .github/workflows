name: Deploy Supabase Edge Functions

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/functions/**'
      - 'supabase/ts/**'
      - '.github/workflows/deploy-supabase.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§© PrÃ©parer les dossiers functions/ Ã  partir de ts/
        run: |
          set -euo pipefail
          echo "ğŸ“ Contenu initial de supabase/ts :"
          ls -l supabase/ts || echo "âŒ Dossier supabase/ts introuvable"

          if compgen -G "supabase/ts/*.ts" > /dev/null; then
            echo "âœ… Fichiers .ts dÃ©tectÃ©s, dÃ©but de traitement"
          else
            echo "âš ï¸ Aucun fichier .ts trouvÃ© dans supabase/ts, rien Ã  copier"
            exit 1
          fi

          rm -rf supabase/functions/*
          mkdir -p supabase/functions

          for file in supabase/ts/*.ts; do
            echo "â¡ï¸ Traitement de $file"
            name=$(basename "$file" .ts)
            dest="supabase/functions/$name"
            mkdir -p "$dest"
            cp "$file" "$dest/index.ts"
            echo "ğŸ“„ CopiÃ© $file â†’ $dest/index.ts"
          done

          if [ -f supabase/import_map.json ]; then
            cp supabase/import_map.json supabase/functions/import_map.json
            echo "âœ… import_map.json copiÃ© dans supabase/functions/"
          else
            echo "âš ï¸ import_map.json non trouvÃ© dans supabase/, le dÃ©ploiement peut Ã©chouer"
            exit 1
          fi

          echo "ğŸ“ Arborescence finale de supabase/functions :"
          find supabase/functions

      - name: ğŸ› ï¸ Install Supabase CLI (v2.30.4)
        run: |
          curl -L https://github.com/supabase/cli/releases/download/v2.30.4/supabase_2.30.4_linux_amd64.deb -o supabase.deb
          sudo dpkg -i supabase.deb
          supabase --version

      - name: ğŸ“¦ Install Deno (runtime for Supabase functions)
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: ğŸš€ Deploy all Edge Functions
        run: |
          supabase functions deploy --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --import-map supabase/functions/import_map.json
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
